import * as functions from 'firebase-functions';
import * as admin from 'firebase-admin';

const db = admin.firestore();

/**
 * Triggered when a new user is created in Firebase Auth.
 * Creates the user's Firestore document with default values.
 */
export const onUserCreate = functions.auth.user().onCreate(async (user) => {
  const { uid, email, displayName, photoURL, phoneNumber } = user;

  // Generate unique referral code
  const referralCode = generateReferralCode(uid);

  // Create user document
  const userData = {
    id: uid,
    email: email || null,
    phone: phoneNumber || null,
    name: displayName || email?.split('@')[0] || 'Utilizador',
    avatarUrl: photoURL || null,
    role: 'user',
    wallet: {
      balance: 0,
      bonusBalance: 0,
      loyaltyPoints: 0,
      loyaltyTier: 'bronze',
      currency: 'CVE',
      totalSpent: 0,
    },
    loyalty: {
      points: 0,
      lifetimePoints: 0,
      tier: 'bronze',
      nextTierAt: 5000,
    },
    referral: {
      code: referralCode,
      referredBy: null,
      referralCount: 0,
      totalEarned: 0,
    },
    createdAt: admin.firestore.FieldValue.serverTimestamp(),
    updatedAt: admin.firestore.FieldValue.serverTimestamp(),
  };

  try {
    await db.collection('users').doc(uid).set(userData);
    functions.logger.info(`User document created for ${uid}`);

    // Check if user was referred (stored in custom claims during signup)
    const customClaims = user.customClaims as { referredBy?: string } | undefined;
    if (customClaims?.referredBy) {
      await processReferral(uid, customClaims.referredBy);
    }
  } catch (error) {
    functions.logger.error(`Error creating user document for ${uid}:`, error);
    throw error;
  }
});

/**
 * Triggered when a user is deleted from Firebase Auth.
 * Cleans up user data (soft delete or anonymize).
 */
export const onUserDelete = functions.auth.user().onDelete(async (user) => {
  const { uid } = user;

  try {
    // Option 1: Soft delete - mark user as deleted
    await db.collection('users').doc(uid).update({
      status: 'deleted',
      email: null,
      phone: null,
      name: 'Utilizador Removido',
      avatarUrl: null,
      deletedAt: admin.firestore.FieldValue.serverTimestamp(),
    });

    // Option 2: Hard delete - uncomment if preferred
    // await db.collection('users').doc(uid).delete();

    functions.logger.info(`User data cleaned up for ${uid}`);

    // Note: Tickets and transactions are kept for audit purposes
    // They reference userId but personal data is anonymized
  } catch (error) {
    functions.logger.error(`Error cleaning up user data for ${uid}:`, error);
    throw error;
  }
});

/**
 * Generate a unique referral code from user ID
 */
function generateReferralCode(uid: string): string {
  const prefix = 'ECV';
  const suffix = uid.substring(0, 6).toUpperCase();
  return `${prefix}${suffix}`;
}

/**
 * Process referral when new user signs up with a referral code
 */
async function processReferral(
  newUserId: string,
  referrerCode: string
): Promise<void> {
  try {
    // Find referrer by code
    const referrerQuery = await db
      .collection('users')
      .where('referral.code', '==', referrerCode)
      .limit(1)
      .get();

    if (referrerQuery.empty) {
      functions.logger.warn(`Referral code not found: ${referrerCode}`);
      return;
    }

    const referrerDoc = referrerQuery.docs[0];
    const referrerId = referrerDoc.id;

    // Update new user with referredBy
    await db.collection('users').doc(newUserId).update({
      'referral.referredBy': referrerId,
    });

    // Update referrer stats
    await db.collection('users').doc(referrerId).update({
      'referral.referralCount': admin.firestore.FieldValue.increment(1),
    });

    // Create referral record for tracking
    await db.collection('referrals').add({
      referrerId,
      referredId: newUserId,
      code: referrerCode,
      status: 'pending', // Becomes 'completed' after first purchase
      createdAt: admin.firestore.FieldValue.serverTimestamp(),
    });

    functions.logger.info(
      `Referral processed: ${referrerId} referred ${newUserId}`
    );
  } catch (error) {
    functions.logger.error('Error processing referral:', error);
  }
}
